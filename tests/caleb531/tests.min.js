(function(e){function V(e){X.layer=t}function $(e){X.canvas=t}function J(e){X.global=t}function K(t){var s={};s[t]=V;e[n](s);s[t]=$;W[r](s);e[n][i][t]=J}function Q(){ok(X.layer,"Triggers layer event callbacks");ok(X.canvas,"Triggers canvas event hooks");ok(X.global,"Triggers global event hooks")}function G(){W=e("<canvas width='500', height='500'></canvas>")}function Y(){X={};e[n].clearCache();e[n][i]={};e[n]()}var t=!0,n="jCanvas",r="setEventHooks",i="eventHooks",s="green",o="saveCanvas",u="data",a="length",f="savedTransforms",l="Pushes transformation state to stack",c="transforms",h="getLayers",p="addLayer",d="rectangle",v="object",m="getLayer",g="square",y="Returns undefined for empty collection",b="Returns undefined for non-canvas",w="arc",E="circle",S="getLayerGroup",x="squares",T="ovals",N="getLayerIndex",C="foo",k="black",L="fillStyle",A="ellipse",O="oval",M="remove",_="addLayerToGroup",D="shapes",P="getEventHooks",H="mousedown",B="fish",j="Width is calculated",F="height",I="Height is calculated",q="text",R="sans-serif",U="Hello",z=e("#qunit-fixture"),W,X={};module("Core API",{setup:G,teardown:Y});test("jCanvas()",function(t){W[n]({fillStyle:s,strokeStyle:"red"});notDeepEqual(e[n].defaults,e[n].prefs,"Modifies preferences");W[n]();deepEqual(e[n].defaults,e[n].prefs,"Restores preferences to defaults")});test("saveCanvas()",function(){var t;W[o]();t=e[u](W[0],n);strictEqual(t[f][a],1,l)});test("restoreCanvas()",function(){var t;W[o]();t=e[u](W[0],n);W.restoreCanvas();strictEqual(t[f][a],0,"Pops transformation state from stack")});test("rotateCanvas()",function(){var t;W.rotateCanvas({rotate:180});t=e[u](W[0],n);strictEqual(t[f][a],1,l);strictEqual(t[c].rotate,Math.PI,"Updates rotate property")});test("scaleCanvas()",function(){var t;W.scaleCanvas({scale:2});t=e[u](W[0],n);strictEqual(t[f][a],1,l);strictEqual(t[c].scaleX,2,"Updates scaleX property");strictEqual(t[c].scaleY,2,"Updates scaleY property")});test("translateCanvas()",function(){var t;W.translateCanvas({translate:2});t=e[u](W[0],n);strictEqual(t[f][a],1,l);strictEqual(t[c].translateX,2,"Updates translateX property");strictEqual(t[c].translateY,2,"Updates translateY property")});module("Layer API",{setup:G,teardown:Y});test("getLayers()",function(){var t;deepEqual(e()[h](),[],"Returns array for empty collection");deepEqual(z[h](),[],"Returns array for non-canvas");t=W[h]();deepEqual(t,[],"Returns empty array for initial canvas");strictEqual(W[h](),t,"Returns a reference to the layers array")});test("addLayer()",function(){W[p]({type:d});var t=W[h]();strictEqual(t[a],1,"Layers was added");strictEqual(e.type(t[0]),v,"Layers is object")});test("getLayer()",function(){var t,n;strictEqual(e()[m](g),undefined,y);strictEqual(z[m](g),undefined,b);strictEqual(W[m](g),undefined,"Returns undefined for non-existent layer");W[p]({type:d,name:g});W[p]({type:w,name:E});t=W[m](0);strictEqual(e.type(t),v,"Layer can be retrieved by positive index");strictEqual(W[m](-2),t,"Layer can be retrieved by negative index");strictEqual(W[m](g),t,"Layer can be retrieved by name");strictEqual(W[m](/^square$/gi),t,"Layer can be retrieved by regex");strictEqual(W[m](t),t,"Layer can be retrieved by object")});test("getLayerGroup()",function(){var t;strictEqual(e()[S](x),undefined,y);strictEqual(z[S](x),undefined,b);strictEqual(W[S](x),undefined,"Returns undefined for non-existent group");W[p]({type:d,name:g,groups:[x]});W[p]({type:w,name:E,groups:[T]});t=W[S](x);strictEqual(e.type(t),"array","Group can be retrieved by index");strictEqual(W[S](/^squares$/gi),t,"Group can be retrieved by regex");strictEqual(W[S](t),t,"Group can be retrieved by object");strictEqual(t[a],1,"Group contains the proper number of layers");strictEqual(t[0],W[m](g),"Group contains the proper layer")});test("getLayerIndex()",function(){strictEqual(e()[N](C),-1,"Returns -1 for empty collection");strictEqual(z[N](C),-1,"Returns -1 for non-canvases");strictEqual(W[N](C),-1,"Returns -1 for non-existent layer");W[p]({type:d,name:g});W[p]({type:w,name:E});strictEqual(W[N](g),0,"Returns index of first layer");strictEqual(W[N](E),1,"Returns index of second layer")});test("setLayer()",function(){var e;K("change");W[p]({type:d,name:g,fillStyle:k});e=W[m](g);W.setLayer(e,{fillStyle:s,name:"box"});strictEqual(e[L],s,"Sets fillStyle of layer");strictEqual(W[m]("box"),e,"Sets name of layer");Q()});test("setLayers()",function(){var e,t;W[p]({type:d,name:g,fillStyle:k});W[p]({type:d,name:E,fillStyle:"red"});e=W[m](g);t=W[m](E);W.setLayers({fillStyle:s});strictEqual(e[L],s,"Sets fillStyle of first layer");strictEqual(t[L],s,"Sets fillStyle of second layer")});test("setLayerGroup()",function(){var e,t,n,r;W[p]({type:d,name:g});W[p]({type:w,name:E,groups:[T]});W[p]({type:A,name:O,groups:[T]});e=W[m](g);t=W[m](E);n=W[m](O);W.setLayerGroup(T,{fillStyle:s});strictEqual(t[L],s,"Sets properties of first layer in group");strictEqual(n[L],s,"Sets properties of second layer in group");notStrictEqual(e[L],s,"Does not set properties of layer outside of group")});test("moveLayer()",function(){K("move");W[p]({type:d,name:g});W[p]({type:w,name:E});W[p]({type:A,name:O});W[n]();W.moveLayer(g,1);strictEqual(W[N](g),1,"Layer can be moved to positive index");W.moveLayer(g,-1);strictEqual(W[N](g),1,"Layer can be moved to negative index");Q()});test("removeLayer()",function(){K(M);W[p]({type:d,name:g});W[p]({type:w,name:E});W.removeLayer(g);strictEqual(W[h]()[a],1,undefined,"Removes layer from layers array");strictEqual(W[m](g),undefined,"Layer is no longer retrievable");Q()});test("removeLayers()",function(){K(M);W[p]({type:d,name:g});W[p]({type:w,name:E});W.removeLayers();strictEqual(W[h]()[a],0,"Removes all layers from layers array");strictEqual(W[m](g),undefined,"First layer is no longer retrievable");strictEqual(W[m](E),undefined,"Second layer is no longer retrievable");Q()});test("removeLayerGroup()",function(){K(M);W[p]({type:d,name:g});W[p]({type:w,name:E,groups:[T]});W[p]({type:A,name:O,groups:[T]});W.removeLayerGroup(T);strictEqual(W[h]()[a],1,"Removes layer group from layers array");strictEqual(W[S](T),undefined,"Layer group is no longer retrievable");Q()});test("addLayerToGroup()",function(){var e,t;W[p]({type:d,name:g,groups:["quadrilaterals"]});W[p]({type:w,name:E});W[p]({type:A,name:O,groups:[]});W[_](g,x);W[_](E,T);W[_](O,T);e=W[S](x);t=W[S](T);strictEqual(e[a],1,"Adds layer to group if layer is associated with at least one group");strictEqual(t[a],2,"Adds layer to group if layer is not associated with any groups")});test("removeLayerFromGroup()",function(){var e,t;W[p]({type:d,name:g,groups:[D,x]});W.removeLayerFromGroup(g,x);e=W[S](D);t=W[S](x);strictEqual(t,undefined,"Removes layer from group");strictEqual(e[a],1,"Layer remains in other groups")});module("Event API",{setup:G,teardown:Y});test("getEventHooks()",function(){deepEqual(e()[P](),{},"Returns object for empty collecion");deepEqual(z[P](),{},"Returns object for non-canvas");deepEqual(W[P](),{},"Returns object for canvas")});test("setEventHooks()",function(){W[r]({add:e.noop});strictEqual(W[P]().add,e.noop,"Sets event hooks for canvas")});test("triggerLayerEvent()",function(){K(H);W[p]({type:d,name:g});W.triggerLayerEvent(g,H);Q()});module("Drawing API",{setup:G,teardown:Y});asyncTest("drawImage()",function(){var e=0;expect(4);W.drawImage({layer:t,name:B,source:"fish.jpg",load:function(t){e+=1;if(e===1){strictEqual(W[m](B),t,"Layer is passed to callback initially");strictEqual(t.width,220,j);strictEqual(t[F],138,I)}else if(e===2){strictEqual(W[m](B),t,"Layer is passed to callback on redraw");start()}}});W.drawLayers()});test("drawText()",function(){var e;W.drawText({layer:t,name:q,fontFamily:R,fontSize:36,text:U});e=W[m](q);ok(e.width,j);ok(e[F],I)});test("measureText()",function(){text=W.measureText({fontFamily:R,fontSize:36,text:U});ok(text.width,j);ok(text[F],I)})})(jQuery);